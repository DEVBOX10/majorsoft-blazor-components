@inherits LayoutComponentBase

<div>
	<NavMenu AppName="Blazor Components (Server)"/>
</div>

<div class="main">
	<div class="top-row px-4">
		<a href="https://github.com/majorimi/blazor-components" target="_blank">About</a>
	</div>

	<div class="content px-4">
		@Body
	</div>
</div>

@using Microsoft.AspNetCore.SignalR.Client;
@using Server.Logging.Console
@inject IJSRuntime _jsRuntime;

@using Blazor.Components.PermaLink
@using Microsoft.Extensions.Logging
@using Blazor.Components.Common.JsInterop.Scroll

@inject IScrollHandler _scrollHandler
@inject NavigationManager _navigationManager
@inject ILogger<IPermaLinkWatcherService> _logger

@implements IDisposable

@code{
	private IPermaLinkWatcherService _permalinkWatcher;

	private HubConnection _hubConnection;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if(firstRender)
		{
			//setup permalink
			_permalinkWatcher = new PermaLinkWatcherService(_scrollHandler, _navigationManager, _logger);
			_permalinkWatcher.WatchPermaLinks();

			//setup console log
			var _hubUrl = _navigationManager.BaseUri.TrimEnd('/') + BlazorServerConsoleLoggingHub.HUB_URL;
			_hubConnection = new HubConnectionBuilder()
				.WithUrl(_hubUrl)
				.Build();
			
			_hubConnection.On<string, LogLevel>("WriteConsoleLogAsync", WriteBrowserLog);
			await _hubConnection.StartAsync();
		}

		//await _hubConnection.SendAsync("WriteConsoleLogAsync", "sent......", LogLevel.Debug);
	}

	private async Task WriteBrowserLog(string message, LogLevel logLevel)
	{
		//System.Console.WriteLine(message);

		var jsName = "Majorsoft.Blazor.Server.Logging.Console/blazor.server.logging.console.js";
@*#else
		var jsName = "Majorsoft.Blazor.Server.Logging.Console/blazor.server.logging.console.min.js";
#endif*@
		await using (var module = await _jsRuntime.InvokeAsync<IJSObjectReference>("import",
			$"./_content/{jsName}"))
		{
			await ServerConsoleLogging.LogConsole(module, message);
		}
	}

	public void Dispose()
	{
		_permalinkWatcher?.Dispose();
	}
}